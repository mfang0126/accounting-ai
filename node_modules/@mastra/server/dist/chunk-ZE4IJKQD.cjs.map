{"version":3,"sources":["../src/server/schemas/prompt-block-versions.ts","../src/server/handlers/prompt-block-versions.ts"],"names":["listVersionsQuerySchema","compareVersionsQuerySchema","createVersionBodySchema","z","ruleGroupSchema","createListVersionsResponseSchema","activateVersionResponseSchema","deleteVersionResponseSchema","createCompareVersionsResponseSchema","createRoute","HTTPException","handleError","extractConfigFromVersion","calculateChangedFields","createVersionWithRetry","enforceRetentionLimit","computeVersionDiffs"],"mappings":"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","file":"chunk-ZE4IJKQD.cjs","sourcesContent":["import z from 'zod';\nimport { ruleGroupSchema } from './rule-group';\nimport {\n  listVersionsQuerySchema,\n  compareVersionsQuerySchema,\n  createVersionBodySchema,\n  activateVersionResponseSchema,\n  deleteVersionResponseSchema,\n  versionDiffEntrySchema,\n  createListVersionsResponseSchema,\n  createCompareVersionsResponseSchema,\n} from './version-common';\n\n// Re-export shared schemas under domain-specific names\nexport const listPromptBlockVersionsQuerySchema = listVersionsQuerySchema;\nexport const comparePromptBlockVersionsQuerySchema = compareVersionsQuerySchema;\nexport const createPromptBlockVersionBodySchema = createVersionBodySchema;\n\n// ============================================================================\n// Path Parameter Schemas\n// ============================================================================\n\nexport const promptBlockVersionPathParams = z.object({\n  promptBlockId: z.string().describe('Unique identifier for the stored prompt block'),\n});\n\nexport const promptBlockVersionIdPathParams = z.object({\n  promptBlockId: z.string().describe('Unique identifier for the stored prompt block'),\n  versionId: z.string().describe('Unique identifier for the version (UUID)'),\n});\n\n// ============================================================================\n// Response Schemas\n// ============================================================================\n\nexport const promptBlockVersionSchema = z.object({\n  id: z.string().describe('Unique identifier for the version (UUID)'),\n  blockId: z.string().describe('ID of the prompt block this version belongs to'),\n  versionNumber: z.number().describe('Sequential version number (1, 2, 3, ...)'),\n  // Snapshot config fields\n  name: z.string().describe('Display name of the prompt block'),\n  description: z.string().optional().describe('Purpose description'),\n  content: z.string().describe('Template content with {{variable}} interpolation'),\n  rules: ruleGroupSchema.optional().describe('Rules for conditional inclusion'),\n  requestContextSchema: z\n    .record(z.string(), z.unknown())\n    .optional()\n    .describe('JSON Schema defining available variables for {{variableName}} interpolation and conditions'),\n  // Version metadata\n  changedFields: z.array(z.string()).optional().describe('Array of field names that changed from the previous version'),\n  changeMessage: z.string().optional().describe('Optional message describing the changes'),\n  createdAt: z.coerce.date().describe('When this version was created'),\n});\n\nexport const listPromptBlockVersionsResponseSchema = createListVersionsResponseSchema(promptBlockVersionSchema);\n\nexport const getPromptBlockVersionResponseSchema = promptBlockVersionSchema;\n\nexport const createPromptBlockVersionResponseSchema = promptBlockVersionSchema.partial().merge(\n  z.object({\n    id: z.string(),\n    blockId: z.string(),\n    versionNumber: z.number(),\n    createdAt: z.coerce.date(),\n  }),\n);\n\nexport const activatePromptBlockVersionResponseSchema = activateVersionResponseSchema;\n\nexport const restorePromptBlockVersionResponseSchema = promptBlockVersionSchema;\n\nexport const deletePromptBlockVersionResponseSchema = deleteVersionResponseSchema;\n\nexport const comparePromptBlockVersionsResponseSchema = createCompareVersionsResponseSchema(promptBlockVersionSchema);\n\nexport { versionDiffEntrySchema };\n","import { HTTPException } from '../http-exception';\nimport {\n  promptBlockVersionPathParams,\n  promptBlockVersionIdPathParams,\n  listPromptBlockVersionsQuerySchema,\n  createPromptBlockVersionBodySchema,\n  comparePromptBlockVersionsQuerySchema,\n  listPromptBlockVersionsResponseSchema,\n  getPromptBlockVersionResponseSchema,\n  createPromptBlockVersionResponseSchema,\n  activatePromptBlockVersionResponseSchema,\n  restorePromptBlockVersionResponseSchema,\n  deletePromptBlockVersionResponseSchema,\n  comparePromptBlockVersionsResponseSchema,\n} from '../schemas/prompt-block-versions';\nimport { createRoute } from '../server-adapter/routes/route-builder';\n\nimport { handleError } from './error';\nimport {\n  extractConfigFromVersion,\n  calculateChangedFields,\n  computeVersionDiffs,\n  createVersionWithRetry,\n  enforceRetentionLimit,\n} from './version-helpers';\nimport type { VersionedStoreInterface } from './version-helpers';\n\nconst SNAPSHOT_CONFIG_FIELDS = ['name', 'description', 'content', 'rules'] as const;\n\n/**\n * GET /stored/prompt-blocks/:promptBlockId/versions - List all versions for a prompt block\n */\nexport const LIST_PROMPT_BLOCK_VERSIONS_ROUTE = createRoute({\n  method: 'GET',\n  path: '/stored/prompt-blocks/:promptBlockId/versions',\n  requiresAuth: true,\n  responseType: 'json',\n  pathParamSchema: promptBlockVersionPathParams,\n  queryParamSchema: listPromptBlockVersionsQuerySchema,\n  responseSchema: listPromptBlockVersionsResponseSchema,\n  summary: 'List prompt block versions',\n  description: 'Returns a paginated list of all versions for a stored prompt block',\n  tags: ['Prompt Block Versions'],\n  handler: async ({ mastra, promptBlockId, page, perPage, orderBy }) => {\n    try {\n      const storage = mastra.getStorage();\n\n      if (!storage) {\n        throw new HTTPException(500, { message: 'Storage is not configured' });\n      }\n\n      const promptBlockStore = await storage.getStore('promptBlocks');\n      if (!promptBlockStore) {\n        throw new HTTPException(500, { message: 'Prompt blocks storage domain is not available' });\n      }\n\n      const promptBlock = await promptBlockStore.getById(promptBlockId);\n      if (!promptBlock) {\n        throw new HTTPException(404, { message: `Prompt block with id ${promptBlockId} not found` });\n      }\n\n      const result = await promptBlockStore.listVersions({\n        blockId: promptBlockId,\n        page,\n        perPage,\n        orderBy,\n      });\n\n      return result;\n    } catch (error) {\n      return handleError(error, 'Error listing prompt block versions');\n    }\n  },\n});\n\n/**\n * POST /stored/prompt-blocks/:promptBlockId/versions - Create a new version snapshot\n */\nexport const CREATE_PROMPT_BLOCK_VERSION_ROUTE = createRoute({\n  method: 'POST',\n  path: '/stored/prompt-blocks/:promptBlockId/versions',\n  requiresAuth: true,\n  responseType: 'json',\n  pathParamSchema: promptBlockVersionPathParams,\n  bodySchema: createPromptBlockVersionBodySchema,\n  responseSchema: createPromptBlockVersionResponseSchema,\n  summary: 'Create prompt block version',\n  description: 'Creates a new version snapshot of the current prompt block configuration',\n  tags: ['Prompt Block Versions'],\n  handler: async ({ mastra, promptBlockId, changeMessage }) => {\n    try {\n      const storage = mastra.getStorage();\n\n      if (!storage) {\n        throw new HTTPException(500, { message: 'Storage is not configured' });\n      }\n\n      const promptBlockStore = await storage.getStore('promptBlocks');\n      if (!promptBlockStore) {\n        throw new HTTPException(500, { message: 'Prompt blocks storage domain is not available' });\n      }\n\n      const promptBlock = await promptBlockStore.getById(promptBlockId);\n      if (!promptBlock) {\n        throw new HTTPException(404, { message: `Prompt block with id ${promptBlockId} not found` });\n      }\n\n      let currentConfig: Record<string, unknown> = {};\n      if (promptBlock.activeVersionId) {\n        const activeVersion = await promptBlockStore.getVersion(promptBlock.activeVersionId);\n        if (activeVersion) {\n          currentConfig = extractConfigFromVersion(\n            activeVersion as unknown as Record<string, unknown>,\n            SNAPSHOT_CONFIG_FIELDS,\n          );\n        }\n      }\n\n      const latestVersion = await promptBlockStore.getLatestVersion(promptBlockId);\n\n      // If no activeVersionId, fall back to latest version config\n      if (!promptBlock.activeVersionId && latestVersion) {\n        currentConfig = extractConfigFromVersion(\n          latestVersion as unknown as Record<string, unknown>,\n          SNAPSHOT_CONFIG_FIELDS,\n        );\n      }\n      const previousConfig = latestVersion\n        ? extractConfigFromVersion(latestVersion as unknown as Record<string, unknown>, SNAPSHOT_CONFIG_FIELDS)\n        : null;\n\n      const changedFields = calculateChangedFields(previousConfig, currentConfig);\n\n      const { versionId } = await createVersionWithRetry(\n        promptBlockStore as unknown as VersionedStoreInterface,\n        promptBlockId,\n        'blockId',\n        currentConfig,\n        changedFields,\n        { changeMessage },\n      );\n\n      const version = await promptBlockStore.getVersion(versionId);\n      if (!version) {\n        throw new HTTPException(500, { message: 'Failed to retrieve created version' });\n      }\n\n      await enforceRetentionLimit(\n        promptBlockStore as unknown as VersionedStoreInterface,\n        promptBlockId,\n        'blockId',\n        promptBlock.activeVersionId,\n      );\n\n      return version;\n    } catch (error) {\n      return handleError(error, 'Error creating prompt block version');\n    }\n  },\n});\n\n/**\n * GET /stored/prompt-blocks/:promptBlockId/versions/:versionId - Get a specific version\n */\nexport const GET_PROMPT_BLOCK_VERSION_ROUTE = createRoute({\n  method: 'GET',\n  path: '/stored/prompt-blocks/:promptBlockId/versions/:versionId',\n  requiresAuth: true,\n  responseType: 'json',\n  pathParamSchema: promptBlockVersionIdPathParams,\n  responseSchema: getPromptBlockVersionResponseSchema,\n  summary: 'Get prompt block version',\n  description: 'Returns a specific version of a prompt block by its version ID',\n  tags: ['Prompt Block Versions'],\n  handler: async ({ mastra, promptBlockId, versionId }) => {\n    try {\n      const storage = mastra.getStorage();\n\n      if (!storage) {\n        throw new HTTPException(500, { message: 'Storage is not configured' });\n      }\n\n      const promptBlockStore = await storage.getStore('promptBlocks');\n      if (!promptBlockStore) {\n        throw new HTTPException(500, { message: 'Prompt blocks storage domain is not available' });\n      }\n\n      const version = await promptBlockStore.getVersion(versionId);\n\n      if (!version) {\n        throw new HTTPException(404, { message: `Version with id ${versionId} not found` });\n      }\n\n      if (version.blockId !== promptBlockId) {\n        throw new HTTPException(404, {\n          message: `Version with id ${versionId} not found for prompt block ${promptBlockId}`,\n        });\n      }\n\n      return version;\n    } catch (error) {\n      return handleError(error, 'Error getting prompt block version');\n    }\n  },\n});\n\n/**\n * POST /stored/prompt-blocks/:promptBlockId/versions/:versionId/activate - Set a version as active\n */\nexport const ACTIVATE_PROMPT_BLOCK_VERSION_ROUTE = createRoute({\n  method: 'POST',\n  path: '/stored/prompt-blocks/:promptBlockId/versions/:versionId/activate',\n  requiresAuth: true,\n  responseType: 'json',\n  pathParamSchema: promptBlockVersionIdPathParams,\n  responseSchema: activatePromptBlockVersionResponseSchema,\n  summary: 'Activate prompt block version',\n  description: 'Sets a specific version as the active version for the prompt block',\n  tags: ['Prompt Block Versions'],\n  handler: async ({ mastra, promptBlockId, versionId }) => {\n    try {\n      const storage = mastra.getStorage();\n\n      if (!storage) {\n        throw new HTTPException(500, { message: 'Storage is not configured' });\n      }\n\n      const promptBlockStore = await storage.getStore('promptBlocks');\n      if (!promptBlockStore) {\n        throw new HTTPException(500, { message: 'Prompt blocks storage domain is not available' });\n      }\n\n      const promptBlock = await promptBlockStore.getById(promptBlockId);\n      if (!promptBlock) {\n        throw new HTTPException(404, { message: `Prompt block with id ${promptBlockId} not found` });\n      }\n\n      const version = await promptBlockStore.getVersion(versionId);\n      if (!version) {\n        throw new HTTPException(404, { message: `Version with id ${versionId} not found` });\n      }\n      if (version.blockId !== promptBlockId) {\n        throw new HTTPException(404, {\n          message: `Version with id ${versionId} not found for prompt block ${promptBlockId}`,\n        });\n      }\n\n      await promptBlockStore.update({\n        id: promptBlockId,\n        activeVersionId: versionId,\n        status: 'published',\n      });\n\n      // Clear the editor cache so subsequent requests see the new active version\n      mastra.getEditor()?.prompt.clearCache(promptBlockId);\n\n      return {\n        success: true,\n        message: `Version ${version.versionNumber} is now active`,\n        activeVersionId: versionId,\n      };\n    } catch (error) {\n      return handleError(error, 'Error activating prompt block version');\n    }\n  },\n});\n\n/**\n * POST /stored/prompt-blocks/:promptBlockId/versions/:versionId/restore - Restore prompt block to a version\n */\nexport const RESTORE_PROMPT_BLOCK_VERSION_ROUTE = createRoute({\n  method: 'POST',\n  path: '/stored/prompt-blocks/:promptBlockId/versions/:versionId/restore',\n  requiresAuth: true,\n  responseType: 'json',\n  pathParamSchema: promptBlockVersionIdPathParams,\n  responseSchema: restorePromptBlockVersionResponseSchema,\n  summary: 'Restore prompt block version',\n  description: 'Restores the prompt block configuration from a version, creating a new version',\n  tags: ['Prompt Block Versions'],\n  handler: async ({ mastra, promptBlockId, versionId }) => {\n    try {\n      const storage = mastra.getStorage();\n\n      if (!storage) {\n        throw new HTTPException(500, { message: 'Storage is not configured' });\n      }\n\n      const promptBlockStore = await storage.getStore('promptBlocks');\n      if (!promptBlockStore) {\n        throw new HTTPException(500, { message: 'Prompt blocks storage domain is not available' });\n      }\n\n      const promptBlock = await promptBlockStore.getById(promptBlockId);\n      if (!promptBlock) {\n        throw new HTTPException(404, { message: `Prompt block with id ${promptBlockId} not found` });\n      }\n\n      const versionToRestore = await promptBlockStore.getVersion(versionId);\n      if (!versionToRestore) {\n        throw new HTTPException(404, { message: `Version with id ${versionId} not found` });\n      }\n      if (versionToRestore.blockId !== promptBlockId) {\n        throw new HTTPException(404, {\n          message: `Version with id ${versionId} not found for prompt block ${promptBlockId}`,\n        });\n      }\n\n      const restoredConfig = extractConfigFromVersion(\n        versionToRestore as unknown as Record<string, unknown>,\n        SNAPSHOT_CONFIG_FIELDS,\n      );\n\n      await promptBlockStore.update({\n        id: promptBlockId,\n        ...restoredConfig,\n      });\n\n      const latestVersion = await promptBlockStore.getLatestVersion(promptBlockId);\n      const previousConfig = latestVersion\n        ? extractConfigFromVersion(latestVersion as unknown as Record<string, unknown>, SNAPSHOT_CONFIG_FIELDS)\n        : null;\n\n      const changedFields = calculateChangedFields(previousConfig, restoredConfig);\n\n      const { versionId: newVersionId } = await createVersionWithRetry(\n        promptBlockStore as unknown as VersionedStoreInterface,\n        promptBlockId,\n        'blockId',\n        restoredConfig,\n        changedFields,\n        {\n          changeMessage: `Restored from version ${versionToRestore.versionNumber}`,\n        },\n      );\n\n      const newVersion = await promptBlockStore.getVersion(newVersionId);\n      if (!newVersion) {\n        throw new HTTPException(500, { message: 'Failed to retrieve created version' });\n      }\n\n      await enforceRetentionLimit(\n        promptBlockStore as unknown as VersionedStoreInterface,\n        promptBlockId,\n        'blockId',\n        promptBlock.activeVersionId,\n      );\n\n      // Clear the editor cache so subsequent requests see the updated config\n      mastra.getEditor()?.prompt.clearCache(promptBlockId);\n\n      return newVersion;\n    } catch (error) {\n      return handleError(error, 'Error restoring prompt block version');\n    }\n  },\n});\n\n/**\n * DELETE /stored/prompt-blocks/:promptBlockId/versions/:versionId - Delete a version\n */\nexport const DELETE_PROMPT_BLOCK_VERSION_ROUTE = createRoute({\n  method: 'DELETE',\n  path: '/stored/prompt-blocks/:promptBlockId/versions/:versionId',\n  requiresAuth: true,\n  responseType: 'json',\n  pathParamSchema: promptBlockVersionIdPathParams,\n  responseSchema: deletePromptBlockVersionResponseSchema,\n  summary: 'Delete prompt block version',\n  description: 'Deletes a specific version (cannot delete the active version)',\n  tags: ['Prompt Block Versions'],\n  handler: async ({ mastra, promptBlockId, versionId }) => {\n    try {\n      const storage = mastra.getStorage();\n\n      if (!storage) {\n        throw new HTTPException(500, { message: 'Storage is not configured' });\n      }\n\n      const promptBlockStore = await storage.getStore('promptBlocks');\n      if (!promptBlockStore) {\n        throw new HTTPException(500, { message: 'Prompt blocks storage domain is not available' });\n      }\n\n      const promptBlock = await promptBlockStore.getById(promptBlockId);\n      if (!promptBlock) {\n        throw new HTTPException(404, { message: `Prompt block with id ${promptBlockId} not found` });\n      }\n\n      const version = await promptBlockStore.getVersion(versionId);\n      if (!version) {\n        throw new HTTPException(404, { message: `Version with id ${versionId} not found` });\n      }\n      if (version.blockId !== promptBlockId) {\n        throw new HTTPException(404, {\n          message: `Version with id ${versionId} not found for prompt block ${promptBlockId}`,\n        });\n      }\n\n      if (promptBlock.activeVersionId === versionId) {\n        throw new HTTPException(400, {\n          message: 'Cannot delete the active version. Activate a different version first.',\n        });\n      }\n\n      await promptBlockStore.deleteVersion(versionId);\n\n      // Clear the editor cache so subsequent requests see the updated config\n      mastra.getEditor()?.prompt.clearCache(promptBlockId);\n\n      return {\n        success: true,\n        message: `Version ${version.versionNumber} deleted successfully`,\n      };\n    } catch (error) {\n      return handleError(error, 'Error deleting prompt block version');\n    }\n  },\n});\n\n/**\n * GET /stored/prompt-blocks/:promptBlockId/versions/compare - Compare two versions\n */\nexport const COMPARE_PROMPT_BLOCK_VERSIONS_ROUTE = createRoute({\n  method: 'GET',\n  path: '/stored/prompt-blocks/:promptBlockId/versions/compare',\n  requiresAuth: true,\n  responseType: 'json',\n  pathParamSchema: promptBlockVersionPathParams,\n  queryParamSchema: comparePromptBlockVersionsQuerySchema,\n  responseSchema: comparePromptBlockVersionsResponseSchema,\n  summary: 'Compare prompt block versions',\n  description: 'Compares two versions and returns the differences between them',\n  tags: ['Prompt Block Versions'],\n  handler: async ({ mastra, promptBlockId, from, to }) => {\n    try {\n      const storage = mastra.getStorage();\n\n      if (!storage) {\n        throw new HTTPException(500, { message: 'Storage is not configured' });\n      }\n\n      const promptBlockStore = await storage.getStore('promptBlocks');\n      if (!promptBlockStore) {\n        throw new HTTPException(500, { message: 'Prompt blocks storage domain is not available' });\n      }\n\n      const fromVersion = await promptBlockStore.getVersion(from);\n      if (!fromVersion) {\n        throw new HTTPException(404, { message: `Version with id ${from} not found` });\n      }\n      if (fromVersion.blockId !== promptBlockId) {\n        throw new HTTPException(404, {\n          message: `Version with id ${from} not found for prompt block ${promptBlockId}`,\n        });\n      }\n\n      const toVersion = await promptBlockStore.getVersion(to);\n      if (!toVersion) {\n        throw new HTTPException(404, { message: `Version with id ${to} not found` });\n      }\n      if (toVersion.blockId !== promptBlockId) {\n        throw new HTTPException(404, {\n          message: `Version with id ${to} not found for prompt block ${promptBlockId}`,\n        });\n      }\n\n      const fromConfig = extractConfigFromVersion(\n        fromVersion as unknown as Record<string, unknown>,\n        SNAPSHOT_CONFIG_FIELDS,\n      );\n      const toConfig = extractConfigFromVersion(\n        toVersion as unknown as Record<string, unknown>,\n        SNAPSHOT_CONFIG_FIELDS,\n      );\n\n      const diffs = computeVersionDiffs(fromConfig, toConfig);\n\n      return {\n        diffs,\n        fromVersion,\n        toVersion,\n      };\n    } catch (error) {\n      return handleError(error, 'Error comparing prompt block versions');\n    }\n  },\n});\n"]}